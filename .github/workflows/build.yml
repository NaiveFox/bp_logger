name: Build Android APK (Flutter hardened)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure minimal Flutter project files
        shell: bash
        run: |
          set -e
          mkdir -p lib
          if [ ! -f lib/main.dart ]; then
            echo "import 'package:flutter/material.dart';" > lib/main.dart
            echo "void main() => runApp(const MaterialApp(home: Scaffold(body: Center(child: Text('bp_logger')))));" >> lib/main.dart
          fi
          if [ ! -f pubspec.yaml ]; then
            echo "name: bp_logger" > pubspec.yaml
            echo "description: BP Logger minimal app" >> pubspec.yaml
            echo "publish_to: 'none'" >> pubspec.yaml
            echo "environment:" >> pubspec.yaml
            echo "  sdk: '>=3.3.0 <4.0.0'" >> pubspec.yaml
            echo "dependencies:" >> pubspec.yaml
            echo "  flutter:" >> pubspec.yaml
            echo "    sdk: flutter" >> pubspec.yaml
            echo "flutter:" >> pubspec.yaml
            echo "  uses-material-design: true" >> pubspec.yaml
          fi

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Create Android folder if missing
        shell: bash
        run: |
          if [ ! -d android ]; then
            flutter create . --org com.naivefox --project-name bp_logger
          fi

      - name: Pin Gradle/AGP/Kotlin
        shell: bash
        run: |
          set -e
          touch android/gradle.properties
          grep -q 'android.useAndroidX=true' android/gradle.properties || echo 'android.useAndroidX=true' >> android/gradle.properties
          grep -q 'android.enableJetifier=true' android/gradle.properties || echo 'android.enableJetifier=true' >> android/gradle.properties
          grep -q 'org.gradle.jvmargs=' android/gradle.properties || echo 'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' >> android/gradle.properties
          # Gradle 7.6 (AGP 7.4.2 совместима)
          sed -i 's#distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-7.6-all.zip#' android/gradle/wrapper/gradle-wrapper.properties || true
          # Корневой build.gradle → Kotlin/AGP
          if [ -f android/build.gradle ]; then
            perl -0777 -pe "s/ext\\.kotlin_version\\s*=\\s*['\\\"][^'\\\"]+['\\\"]/ext.kotlin_version = '1.8.22'/g" -i android/build.gradle || true
            perl -0777 -pe "s#classpath ['\\\"]com\\.android\\.tools\\.build:gradle:[^'\\\"]+['\\\"]#classpath 'com.android.tools.build:gradle:7.4.2'#g" -i android/build.gradle || true
          fi
          APP_GRADLE="android/app/build.gradle"
          # compileSdk / target / min
          perl -0777 -pe "s/compileSdkVersion\\s+\\d+/compileSdkVersion 34/g" -i "$APP_GRADLE" || true
          perl -0777 -pe "s/targetSdkVersion\\s+\\d+/targetSdkVersion 34/g" -i "$APP_GRADLE" || true
          grep -q "compileSdkVersion 34" "$APP_GRADLE" || sed -i "/android {/a \ \ \ \ compileSdkVersion 34" "$APP_GRADLE"
          # namespace если нет
          grep -q "namespace " "$APP_GRADLE" || sed -i "/android {/a \ \ \ \ namespace 'com.naivefox.bp_logger'" "$APP_GRADLE"
          # Java/Kotlin 17 совместимость
          perl -0777 -pe "s/sourceCompatibility\\s*=\\s*JavaVersion\\.[A-Z_0-9]+/sourceCompatibility = JavaVersion.VERSION_17/g" -i "$APP_GRADLE" || true
          perl -0777 -pe "s/targetCompatibility\\s*=\\s*JavaVersion\\.[A-Z_0-9]+/targetCompatibility = JavaVersion.VERSION_17/g" -i "$APP_GRADLE" || true
          grep -q "compileOptions" "$APP_GRADLE" || sed -i "/android {/a \ \ \ \ compileOptions { sourceCompatibility JavaVersion.VERSION_17; targetCompatibility JavaVersion.VERSION_17 }" "$APP_GRADLE"
          # kotlinOptions jvmTarget
          grep -q "kotlinOptions" "$APP_GRADLE" || sed -i "/android {/a \ \ \ \ kotlinOptions { jvmTarget = '17' }" "$APP_GRADLE"
          # stdlib той же версии Kotlin
          grep -q "kotlin-stdlib" "$APP_GRADLE" || sed -i "/dependencies {/a \ \ \ implementation \"org.jetbrains.kotlin:kotlin-stdlib-jdk8:\${kotlin_version}\"" "$APP_GRADLE"

      - name: flutter pub get
        run: flutter pub get

      - name: Bump Kotlin plugin inside all Flutter plugins
        shell: bash
        run: |
          if [ -d "$HOME/.pub-cache" ]; then
            find "$HOME/.pub-cache" -type f -path "*android/build.gradle" -print0 \
            | xargs -0 -I {} bash -lc "sed -i -E \"s/kotlin-gradle-plugin:[0-9][0-9.]+/kotlin-gradle-plugin:1.8.22/g; s/ext.kotlin_version\\s*=\\s*'[0-9.]+'/ext.kotlin_version = '1.8.22'/g\" {}" || true
          fi

      - name: Clean & Build (verbose)
        shell: bash
        run: |
          set -e
          flutter clean
          # подробный лог, чтобы видеть первопричину, если вдруг упадёт
          flutter build apk --release -v --dart-define=CI=true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error     
