name: Build Android APK (safe version)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure minimal Flutter project
        shell: bash
        run: |
          set -e
          mkdir -p lib
          if [ ! -f lib/main.dart ]; then
            echo "import 'package:flutter/material.dart';" > lib/main.dart
            echo "void main() => runApp(const MaterialApp(home: Scaffold(body: Center(child: Text('bp_logger')))));" >> lib/main.dart
          fi

          if [ ! -f pubspec.yaml ]; then
            printf "%s\n" \
"name: bp_logger" \
"description: BP Logger minimal app" \
"publish_to: 'none'" \
"environment:" \
"  sdk: '>=3.3.0 <4.0.0'" \
"dependencies:" \
"  flutter:" \
"    sdk: flutter" \
"flutter:" \
"  uses-material-design: true" > pubspec.yaml
          fi

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Ensure Android structure (KTS-safe)
        shell: bash
        run: |
          set -e
          if [ ! -d android/app ]; then
            echo "Creating Android platform..."
            rm -rf android || true
            flutter create . --platforms android --org com.naivefox --project-name bp_logger
          fi
          echo "✅ Android folder content:"
          ls -R android

      - name: Patch Gradle/AGP/Kotlin (auto detect)
        shell: bash
        run: |
          set -e
          APP_GRADLE="android/app/build.gradle"
          APP_KTS="android/app/build.gradle.kts"

          if [ -f "$APP_KTS" ]; then
            TARGET_FILE="$APP_KTS"
            echo "Detected Kotlin DSL (.kts)"
          elif [ -f "$APP_GRADLE" ]; then
            TARGET_FILE="$APP_GRADLE"
            echo "Detected Groovy DSL (.gradle)"
          else
            echo "❌ Neither build.gradle nor build.gradle.kts found!"
            exit 1
          fi

          touch android/gradle.properties
          echo 'android.useAndroidX=true' >> android/gradle.properties
          echo 'android.enableJetifier=true' >> android/gradle.properties
          echo 'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' >> android/gradle.properties

          if [ -f android/build.gradle ]; then
            sed -i 's/ext.kotlin_version.*/ext.kotlin_version = "1.8.22"/' android/build.gradle || true
          elif [ -f android/build.gradle.kts ]; then
            sed -i 's/kotlin("jvm") version.*/kotlin("jvm") version "1.8.22"/' android/build.gradle.kts || true
          fi

          if [[ "$TARGET_FILE" == *".kts" ]]; then
            sed -i '/android {/a\    compileSdk = 34\n    namespace = "com.naivefox.bp_logger"' "$TARGET_FILE" || true
            sed -i '/compileOptions {/a\        sourceCompatibility = JavaVersion.VERSION_17\n        targetCompatibility = JavaVersion.VERSION_17' "$TARGET_FILE" || true
            sed -i '/dependencies {/a\    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8")' "$TARGET_FILE" || true
          else
            sed -i '/android {/a\    compileSdkVersion 34\n    namespace "com.naivefox.bp_logger"' "$TARGET_FILE" || true
            sed -i '/compileOptions {/a\        sourceCompatibility JavaVersion.VERSION_17\n        targetCompatibility JavaVersion.VERSION_17' "$TARGET_FILE" || true
            sed -i '/dependencies {/a\    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlin_version"' "$TARGET_FILE" || true
          fi

      - name: flutter pub get
        run: flutter pub get

      - name: Build release APK (verbose)
        run: flutter build apk --release -v --dart-define=CI=true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
