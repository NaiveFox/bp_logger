name: Build Android APK (clean)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: false

      - name: Show Flutter & Dart versions
        run: |
          flutter --version
          dart --version

      - name: Ensure project in ./app exists
        shell: bash
        run: |
          set -e
          mkdir -p app
          cd app
          # Если нет pubspec.yaml — создадим минимальный
          if [ ! -f pubspec.yaml ]; then
            cat > pubspec.yaml <<'YAML'
name: bp_logger
description: BP Logger minimal app
publish_to: "none"
environment:
  sdk: ">=3.3.0 <4.0.0"
dependencies:
  flutter:
    sdk: flutter
flutter:
  uses-material-design: true
YAML
          fi
          # Если нет lib/main.dart — создадим болванку
          mkdir -p lib
          if [ ! -f lib/main.dart ]; then
            cat > lib/main.dart <<'DART'
import 'package:flutter/material.dart';
void main() => runApp(const MaterialApp(home: Scaffold(body: Center(child: Text('BP Logger placeholder')))));
DART
          fi
          # Если нет android-папки — сгенерируем
          if [ ! -d android ]; then
            flutter create .
          fi

      - name: Clean caches (Flutter/Gradle) — гарантированно без старья
        shell: bash
        run: |
          set -e
          cd app
          flutter clean
          rm -rf build
          # подчистим gradle-кеши, чтобы версия/манифест не прилипали
          rm -rf ~/.gradle/caches ~/.gradle/wrapper
          rm -rf android/.gradle
          flutter pub get

      - name: Build release APK (verbose)
        shell: bash
        run: |
          set -e
          cd app
          # На случай редких конфликтов Kotlin/AGP — принудительно синкнём gradle-wrapper
          sed -i 's/distributionUrl=.*/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.7-bin.zip/' android/gradle/wrapper/gradle-wrapper.properties || true
          flutter build apk --release --no-tree-shake-icons -v
          ls -lah build/app/outputs/flutter-apk || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: |
            app/build/app/outputs/flutter-apk/app-release.apk
            app/build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
