name: Build Android APK (bulletproof)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Doctor
        run: |
          flutter --version
          flutter doctor -v
          dart --version

      - name: Prepare project
        shell: bash
        run: |
          set -e
          cd app

          if [ ! -d android ]; then
            flutter create . --org com.naivefox --project-name bp_logger
          fi

          flutter pub get

          # ---------- Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Kotlin / Gradle ----------
          TOML="android/gradle/libs.versions.toml"
          if [ -f "$TOML" ]; then
            echo "ðŸ”§ Forcing Kotlin=1.9.24 + AGP=8.5.2 in libs.versions.toml"
            sed -i 's/^kotlin *= *.*/kotlin = "1.9.24"/' "$TOML" || true
            sed -i 's/^agp *= *.*/agp = "8.5.2"/' "$TOML" || true
            grep -q 'kotlin = "1.9.24"' "$TOML" || echo 'kotlin = "1.9.24"' >> "$TOML"
            grep -q 'agp = "8.5.2"' "$TOML"   || echo 'agp = "8.5.2"'   >> "$TOML"
          fi

          for F in android/build.gradle android/build.gradle.kts; do
            if [ -f "$F" ]; then
              sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[^"'"'"']*/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24/' "$F" || true
            fi
          done

          GP="android/gradle.properties"
          touch "$GP"

          grep -q '^org.gradle.jvmargs=' "$GP" || echo 'org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8' >> "$GP"
          grep -q '^android.useAndroidX=' "$GP" || echo 'android.useAndroidX=true' >> "$GP"
          grep -q '^android.enableJetifier=' "$GP" || echo 'android.enableJetifier=true' >> "$GP"
          grep -q '^android.enableR8=' "$GP" || echo 'android.enableR8=false' >> "$GP"
          grep -q '^android.useFullClasspathForDexingTransform=' "$GP" || echo 'android.useFullClasspathForDexingTransform=true' >> "$GP"

          echo "----- gradle.properties -----"
          cat "$GP"
          echo "------------------------------"

      - name: Build release APK (verbose)
        shell: bash
        run: |
          set -e
          cd app
          echo "ðŸš€ Building release APK..."
          flutter build apk --release -v

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: app/build/app/outputs/flutter-apk/app-release.apk
