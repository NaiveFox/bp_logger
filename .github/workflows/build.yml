name: build-android

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Flutter doctor (sanity)
        run: flutter doctor -v

      - name: Bootstrap project (create android, copy app/, pub get)
        shell: bash
        run: |
          set -euxo pipefail

          # 0) Уберём то, что могло остаться от прошлых прогонов
          rm -rf android

          # 1) Создаём android-хост с нужным org/пакетом
          flutter create --platforms=android --org com.naivefox --project-name bp_logger .

          # 2) Перекладываем исходники: app/lib -> lib
          if [ -d app/lib ]; then
            rm -rf lib
            mkdir -p lib
            cp -R app/lib/* lib/
          fi

          # 3) Правим namespace / applicationId в app/build.gradle(.kts)
          APP_GRADLE_KTS="android/app/build.gradle.kts"
          APP_GRADLE="android/app/build.gradle"

          if [ -f "$APP_GRADLE_KTS" ]; then
            sed -i 's/^namespace = .*/namespace = "com.naivefox.bp_logger"/' "$APP_GRADLE_KTS" || true
            sed -i 's/applicationId = ".*"/applicationId = "com.naivefox.bp_logger"/' "$APP_GRADLE_KTS" || true
          fi

          if [ -f "$APP_GRADLE" ]; then
            sed -i 's/^namespace .*=.*/namespace "com.naivefox.bp_logger"/' "$APP_GRADLE" || true
            sed -i 's/applicationId ".*"/applicationId "com.naivefox.bp_logger"/' "$APP_GRADLE" || true
          fi

          # 4) gradle.properties (AndroidX/Jetifier, кодировка)
          cat > android/gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # 5) Чиним AndroidManifest под v2-эмбеддинг
          MANIFEST="android/app/src/main/AndroidManifest.xml"

          # гарантируем корректный путь к MainActivity и встраиваем meta-data для v2
          sed -i '/android:name="\${applicationName}"/d' "$MANIFEST" || true
          sed -i 's/android:name="\.MainActivity"/android:name="com.naivefox.bp_logger.MainActivity"/' "$MANIFEST" || true

          awk '
            BEGIN{ins=0}
            /<application[^>]*>/ && ins==0 {
              print
              print "    <meta-data android:name=\"flutterEmbedding\" android:value=\"2\" />"
              ins=1
              next
            }
            {print}
          ' "$MANIFEST" > "$MANIFEST.tmp" && mv "$MANIFEST.tmp" "$MANIFEST"

          # 6) Финальный pub get
          flutter pub get

      - name: Build release APK
        shell: bash
        run: |
          set -euxo pipefail
          # После перекладки исходников точка входа — lib/main.dart
          flutter build apk --release --target=lib/main.dart

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
