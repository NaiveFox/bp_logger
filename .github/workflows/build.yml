name: Build Android APK (clean)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Show Flutter & Dart versions
        run: |
          flutter --version
          dart --version

      - name: Ensure project in ./app exists
        shell: bash
        run: |
          set -e
          mkdir -p app
          cd app
          # Если нет pubspec.yaml — создадим минимальный
          if [ ! -f pubspec.yaml ]; then
            cat > pubspec.yaml << 'EOF'
name: bp_logger
description: BP Logger minimal app
publish_to: "none"
environment:
  sdk: ">=3.3.0 <4.0.0"
dependencies:
  flutter:
    sdk: flutter
flutter:
  uses-material-design: true
EOF
          fi
          # Если нет lib/main.dart — создадим болванку
          mkdir -p lib
          if [ ! -f lib/main.dart ]; then
            cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
void main() => runApp(const MaterialApp(home: Scaffold(body: Center(child: Text('BP Logger placeholder')))));
EOF
          fi
          # Если нет android-папки — сгенерируем
          if [ ! -d android ]; then
            flutter create . --org com.naivefox
          fi

      - name: Clean caches
        shell: bash
        run: |
          set -e
          cd app
          flutter clean
          rm -rf build
          rm -rf android/.gradle android/build
          flutter pub get

      - name: Build release APK (verbose)
        shell: bash
        run: |
          set -e
          cd app
          sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-7.6-all.zip|' android/gradle/wrapper/gradle-wrapper.properties || true
          flutter build apk --release --no-tree-shake-icons -v
          ls -lah build/app/outputs/flutter-apk/ || echo "APK directory not found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: |
            app/build/app/outputs/flutter-apk/app-release.apk
            app/build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
