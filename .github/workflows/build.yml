name: Build Android APK (bulletproof)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Doctor
        run: |
          flutter --version
          flutter doctor -v
          dart --version

      - name: Prepare project
        shell: bash
        run: |
          set -e
          cd app

          # –ï—Å–ª–∏ –Ω–µ—Ç android-–ø–∞–ø–∫–∏ ‚Äì —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é
          if [ ! -d android ]; then
            flutter create . --org com.naivefox --project-name bp_logger
          fi

          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—ã
          flutter pub get

          # ---------- –ü–ò–ù–´ –≤–µ—Ä—Å–∏–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ----------
          # Flutter stable –æ–∂–∏–¥–∞–µ—Ç Kotlin 1.9.24 + AGP 8.5.x (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Gradle 8.7)
          # 1) –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: android/gradle/libs.versions.toml
          TOML="android/gradle/libs.versions.toml"
          if [ -f "$TOML" ]; then
            echo "üîß Forcing Kotlin=1.9.24 + AGP=8.5.2 in libs.versions.toml"
            sed -i 's/^kotlin *= *.*/kotlin = "1.9.24"/' "$TOML" || true
            sed -i 's/^agp *= *.*/agp = "8.5.2"/' "$TOML" || true
            grep -q 'kotlin = "1.9.24"' "$TOML" || echo 'kotlin = "1.9.24"' >> "$TOML"
            grep -q 'agp = "8.5.2"' "$TOML"   || echo 'agp = "8.5.2"'   >> "$TOML"
          fi

          # 2) –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: android/build.gradle(.kts) –∏ android/app/build.gradle(.kts)
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–Ω–∏–∂–∞–µ–º Kotlin Gradle Plugin –¥–æ 1.9.24
          for F in android/build.gradle android/build.gradle.kts; do
            if [ -f "$F" ]; then
              sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[^"'"'"']*/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24/' "$F" || true
            fi
          done

          # 3) gradle.properties ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∏ –ø–∞–º—è—Ç—å
          GP="android/gradle.properties"
          touch "$GP"
          grep -q '^org.gradle.jvmargs=' "$GP" || echo 'org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8' >> "$GP"
          grep -q '^android.useAndroidX=' "$GP" || echo 'android.useAndroidX=true' >> "$GP"
          grep -q '^android.enableJetifier=' "$GP" || echo 'android.enableJetifier=true' >> "$GP"
          # –í–∫–ª—é—á–∏–º R8/DEX —Ñ–ª–∞–≥–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º —Ä–µ–∂–∏–º–µ
          grep -q '^android.enableR8=' "$GP" || echo 'android.enableR8=false' >> "$GP"
          grep -q '^android.enableDexingArtifactTransform=' "$GP" || echo 'android.enableDexingArtifactTransform=false' >> "$GP"

          # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π gradle-wrapper.properties –Ω–µ —Ç—Ä–æ–≥–∞–µ–º,
          # flutter —Å–∞–º –ø–æ–¥—Ç—è–Ω–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π Gradle –ø–æ–¥ stable.

      - name: Build release APK (verbose)
        shell: bash
        run: |
          set -e
          cd app
          flutter build apk --release -v

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: app/build/app/outputs/flutter-apk/app-release.apk
