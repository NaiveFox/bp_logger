 name: Build Android APK (bulletproof)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Doctor
        run: |
          flutter --version
          flutter doctor -v
          dart --version

      - name: Prepare project
        shell: bash
        run: |
          set -e
          cd app

          # –ï—Å–ª–∏ –Ω–µ—Ç android-–ø–∞–ø–∫–∏ ‚Äî —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          if [ ! -d android ]; then
            flutter create . --org com.naivefox --project-name bp_logger
          fi

          # –ü–æ–¥—Ç—è–Ω—É—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          flutter pub get

          # ---------- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Kotlin / Gradle ----------
          # Flutter stable –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Gradle 8.7 –∏ Kotlin 1.9.24
          # –û–±–Ω–æ–≤–ª—è–µ–º libs.versions.toml –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          TOML="android/gradle/libs.versions.toml"
          if [ -f "$TOML" ]; then
            echo "üîß Forcing Kotlin=1.9.24 + AGP=8.5.2 in libs.versions.toml"
            sed -i 's/^kotlin *= *.*/kotlin = "1.9.24"/' "$TOML" || true
            sed -i 's/^agp *= *.*/agp = "8.5.2"/' "$TOML" || true
            grep -q 'kotlin = "1.9.24"' "$TOML" || echo 'kotlin = "1.9.24"' >> "$TOML"
            grep -q 'agp = "8.5.2"' "$TOML"   || echo 'agp = "8.5.2"'   >> "$TOML"
          fi

          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º Kotlin Gradle Plugin –≤ build.gradle(.kts)
          for F in android/build.gradle android/build.gradle.kts; do
            if [ -f "$F" ]; then
              sed -i 's/org.jetbrains.kotlin:kotlin-gradle-plugin:[^"'"'"']*/org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24/' "$F" || true
            fi
          done

          # ---------- gradle.properties ----------
          GP="android/gradle.properties"
          touch "$GP"

          # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã JVM –∏ AndroidX
          grep -q '^org.gradle.jvmargs=' "$GP" || echo 'org.gradle.jvmargs=-Xmx2g -Dfile.encoding=UTF-8' >> "$GP"
          grep -q '^android.useAndroidX=' "$GP" || echo 'android.useAndroidX=true' >> "$GP"
          grep -q '^android.enableJetifier=' "$GP" || echo 'android.enableJetifier=true' >> "$GP"

          # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π R8 –∏ –Ω–æ–≤—ã–µ DEX-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          grep -q '^android.enableR8=' "$GP" || echo 'android.enableR8=false' >> "$GP"
          # ‚ö†Ô∏è –ù–æ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –≤–º–µ—Å—Ç–æ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ android.enableDexingArtifactTransform
          grep -q '^android.useFullClasspathForDexingTransform=' "$GP" || echo 'android.useFullClasspathForDexingTransform=true' >> "$GP"

          # –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ gradle.properties
          echo "----- gradle.properties -----"
          cat "$GP"
          echo "------------------------------"

      - name: Build release APK (verbose)
        shell: bash
        run: |
          set -e
          cd app
          echo "üöÄ Building release APK..."
          flutter build apk --release -v

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: app/build/app/outputs/flutter-apk/app-release.apk         
