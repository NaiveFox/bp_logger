name: Build Android APK (Flutter, self-healing)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "lib/**"
      - "pubspec.yaml"
      - ".github/workflows/build.yml"

jobs:
  android-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure minimal project skeleton
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p lib
          if [ ! -f lib/main.dart ]; then
            cat > lib/main.dart <<'EOF'
import 'package:flutter/material.dart';
void main() => runApp(const MaterialApp(home: Scaffold(body: Center(child: Text('bp_logger')))));
EOF
          fi
          if [ ! -f pubspec.yaml ]; then
            cat > pubspec.yaml <<'EOF'
name: bp_logger
description: BP Logger minimal app
publish_to: "none"
environment:
  sdk: ">=3.3.0 <4.0.0"
dependencies:
  flutter:
    sdk: flutter
flutter:
  uses-material-design: true
EOF
          fi

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Create Android folder if missing
        shell: bash
        run: |
          set -euxo pipefail
          if [ ! -d android ]; then
            flutter create . --org com.naivefox --project-name bp_logger
          fi

      - name: Pin Gradle/AGP/Kotlin and gradle.properties
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p android
          touch android/gradle.properties
          grep -q 'android.useAndroidX=true' android/gradle.properties || echo 'android.useAndroidX=true' >> android/gradle.properties
          grep -q 'android.enableJetifier=true' android/gradle.properties || echo 'android.enableJetifier=true' >> android/gradle.properties
          grep -q 'org.gradle.jvmargs=' android/gradle.properties || echo 'org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8' >> android/gradle.properties
          # Gradle wrapper → 7.6 (совместим с AGP 7.4.2)
          sed -i 's#distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-7.6-all.zip#' android/gradle/wrapper/gradle-wrapper.properties || true
          # Корневой build.gradle: фиксируем версии
          if [ -f android/build.gradle ]; then
            perl -0777 -pe "s/ext\\.kotlin_version\\s*=\\s*['\\\"][0-9\\.\\-rc]+['\\\"]/ext.kotlin_version = '1.8.22'/g" -i android/build.gradle || true
            perl -0777 -pe "s/classpath\\s*['\\\"]com\\.android\\.tools\\.build:gradle:[^'\\\"]+['\\\"]/classpath 'com.android.tools.build:gradle:7.4.2'/g" -i android/build.gradle || true
          fi

      - name: Ensure namespace and SDK knobs
        shell: bash
        run: |
          set -euxo pipefail
          APP_GRADLE="android/app/build.gradle"
          if ! grep -q "namespace " "$APP_GRADLE"; then
            perl -0777 -pe "s/android\\s*\\{/android {\n    namespace 'com.naivefox.bp_logger'/;" -i "$APP_GRADLE" || echo "android { namespace 'com.naivefox.bp_logger' }" >> "$APP_GRADLE"
          fi
          perl -0777 -pe "s/minSdkVersion\\s+\\d+/minSdkVersion 21/g" -i "$APP_GRADLE" || true

      - name: flutter pub get
        run: flutter pub get

      - name: Safety net: bump Kotlin plugin inside all downloaded Flutter plugins
        shell: bash
        run: |
          set -euxo pipefail
          if [ -d "$HOME/.pub-cache" ]; then
            find "$HOME/.pub-cache" -type f -path "*android/build.gradle" -print0 \
              | xargs -0 -I {} bash -lc "sed -i -E \"s/kotlin-gradle-plugin:[0-9][0-9.]+/kotlin-gradle-plugin:1.8.22/g; s/ext.kotlin_version\\s*=\\s*'[0-9.]+'/ext.kotlin_version = '1.8.22'/g\" {}" || true
          fi

      - name: Build release APK (universal)
        run: |
          set -euxo pipefail
          flutter build apk --release --dart-define=CI=true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bp_logger-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error

      - name: Done
        run: echo "✅ APK built and uploaded."
